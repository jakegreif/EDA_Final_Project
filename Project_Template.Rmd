---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: Experiment Title
subtitle: Web address for GitHub repository
author: Your Name
abstract: "Experimental overview. This section should be no longer than 250 words."
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

<Information in these brackets are used for annotating the RMarkdown file. They will not appear in the final version of the PDF document>

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

<Setup the global options for the R chunks in your document>
```{r}
library(GlobalOptions)

#set_opt(warning=FALSE, )
```

<Note: set up autoreferencing for figures and tables in your document>

```{r setup, include=FALSE}
# Set your working directory
setwd("/Users/jakegreif/Environmental_Data_Analytics/EDA_Final_Project")

# Load your packages
library(tidyverse)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(trend)

# Set your ggplot theme
mytheme <- theme_bw(base_size = 14) +
  theme(strip.background = element_rect(fill = "white")) +
  theme(plot.title = element_text(hjust=0.5))

theme_set(mytheme)
```


# Research Question and Rationale

<Paragraph detailing the rationale for your analysis. What is the significant application and/or interest in this topic? Connect to environmental topic(s)/challenge(s).>

Across the country, the expected effects of climate change are being
realized in the form of more intense precipitation events and dry
periods. In North Texas, the city of Dallas is familiar with intense
storms as it resides in a portion of the country where warm air from 
the Gulf of Mexico and cool air flowing down from the Rocky Mountains 
converge, producing dramatic storms. Though, the city is also 
accustomed to dry spells, particularly in the summer. Despite the 
famaliarity this region has with both hydrologic extremes, it has 
experienced particularly intense events in recent years. Therefore, 
this project will examine trends in the flow of the Trinity River 
and a tributary of the Trinity River near Dallas, TX. In particular,
the analysis will attempt to determine if extreme flow rates have 
become more prevalent in recent decades compared to discharges over
the past centry.

<Paragraph detailing your research question(s) and goals. What do you want to find out? Include a sentence (or a few) on the dataset you are using to answer this question - just enough to give your reader an idea of where you are going with the analysis.>

Have extreme discharge events become more frequent in the Dallas area?
How do the frequency of extreme discharge events in higher and lower 
order streams in the area compare? To answer this question, data from 
both USGS site 08057000 on the Trinity river in Dallas, TX and USGS 
site 08049500 on the West Fork Trinity River in Grand Prairie, TX will 
be analyzed. Specifically, the mean daily discharge at both sites will 
be characterized based on the frequency of occurance. As per USGS 
percentile thresholds, a discharge that falls above the 75th percentile
is considered to be above normal, and a discharge that falls below the 
25th percentile is considered below normal. Therefore, in the context 
of this analysis, a discharge above the 75th percentile is considered 
a "flood", and a discharge below the 25th percentile is considered a 
"drought." The goal of this analysis is to determine if recent extreme 
events are indicative of an emerging trend, as well as if...
\newpage

# Dataset Information

<Information on how the dataset for this analysis were collected, the data contained in the dataset, and any important pieces of information that are relevant to your analyses. This section should contain much of same information as the README file for the dataset but formatted in a way that is more narrative.>



<Add a table that summarizes your data structure. This table can be made in markdown text or inserted as a `kable` function in an R chunk. If the latter, do not include the code used to generate your table.>

\newpage

# Exploratory Data Analysis and Wrangling

<Include R chunks for 5+ lines of summary code (display code and output), 3+ exploratory graphs (display graphs only), and any wrangling you do to your dataset(s).> 

```{r warning=FALSE, results='markup'}
## Data Wrangling
trinity.raw <- read.csv("../EDA_Final_Project/Data/Raw_Data/USGS_Site08057000_Flow_Raw.csv")
westfork.raw <- read.csv("../EDA_Final_Project/Data/Raw_Data/USGS_Site08049500_Flow_Raw.csv")

class(trinity.raw)
class(westfork.raw)

colnames(trinity.raw)
colnames(westfork.raw)

colnames(trinity.raw) <- c("agency_cd", "site_no", "datetime", 
                              "discharge.max", "discharge.max.approval", 
                              "discharge.min", "discharge.min.approval", 
                              "discharge.mean", "discharge.mean.approval")
colnames(westfork.raw) <- c("agency_cd", "site_no", "datetime", 
                              "discharge.max", "discharge.max.approval", 
                              "discharge.min", "discharge.min.approval", 
                              "discharge.mean", "discharge.mean.approval")

head(trinity.raw)
head(westfork.raw)

class(trinity.raw$datetime)
class(westfork.raw$datetime)

# Convert "datetime" class to date
trinity.raw$datetime <- as.Date(trinity.raw$datetime, 
                                               format = "%m/%d/%y")
westfork.raw$datetime <- as.Date(westfork.raw$datetime, 
                                               format = "%m/%d/%y")

# Fix years before 1925
trinity.raw$datetime <- format(trinity.raw$datetime, "%y%m%d")
westfork.raw$datetime <- format(westfork.raw$datetime, "%y%m%d")

create.early.dates <- (function(d) {
       paste0(ifelse(d > 190404,"19","20"),d)
       })

trinity.raw$datetime <- create.early.dates(trinity.raw$datetime)
westfork.raw$datetime <- create.early.dates(westfork.raw$datetime)

# Reformat dates
trinity.raw$datetime <- as.Date(trinity.raw$datetime, 
                                               format = "%Y%m%d")
westfork.raw$datetime <- as.Date(westfork.raw$datetime, 
                                               format = "%Y%m%d")

# Convert "site_no" class to character
trinity.raw$site_no <- as.character(trinity.raw$site_no)
westfork.raw$site_no <- as.character(westfork.raw$site_no)

# Separate "datetime" column
trinity.raw <- separate(trinity.raw, datetime, c("Year", "Month", "Day"))
westfork.raw <- separate(westfork.raw, datetime, c("Year", "Month", "Day"))

# Thin data to contain only mean discharge
trinity.thinned <- select(trinity.raw, site_no, Year, discharge.mean)
westfork.thinned <- select(westfork.raw, site_no, Year, discharge.mean)

# Remove "discharge.mean" NAs
trinity.flow <- na.omit(trinity.thinned)
westfork.flow <- na.omit(westfork.thinned)

# Merge datasets
all.flow.data <- merge(trinity.flow, westfork.flow, all = TRUE)
```

```{r}
# Create 'daynum' column in order to run Spearman's Rho test
trinity.flow <- mutate(trinity.flow, daynum = 1:nrow(trinity.flow))
westfork.flow <- mutate(westfork.flow, daynum = 1:nrow(westfork.flow))

trinity.flow$daynum <- as.numeric(trinity.flow$daynum)
westfork.flow$daynum <- as.numeric(westfork.flow$daynum)

trinity.flow$daynum <- as.numeric(trinity.flow$daynum)
westfork.flow$daynum <- as.numeric(westfork.flow$daynum)
```

Create new dataframes of flood/drought occurance by year for analysis
```{r}
# Determine extreme event thresholds
quantile(trinity.flow$discharge.mean)
quantile(westfork.flow$discharge.mean)

# Create flood/drought data frames
trinity.flood <- filter(trinity.flow, discharge.mean >= 1580)
trinity.drought <- filter(trinity.flow, discharge.mean <= 250)
westfork.flood <- filter(westfork.flow, discharge.mean >= 512.25)
westfork.drought <- filter(westfork.flow, discharge.mean <= 115)

# Create count column of frequency of extreme events by year
trinity.flood.freq <- count(trinity.flood, "Year")
trinity.drought.freq <- count(trinity.drought, "Year")
westfork.flood.freq <- count(westfork.flood, "Year")
westfork.drought.freq <- count(westfork.drought, "Year")

# Append "site_no" column to frequency dataframes
trinity.flood.freq$site_no <- c(08057000)
trinity.drought.freq$site_no <- c(08057000)
westfork.flood.freq$site_no <- c(08049500)
westfork.drought.freq$site_no <- c(08049500)

# Rearrange columns
trinity.flood.freq <- select(trinity.flood.freq, site_no, Year, freq)
trinity.drought.freq <- select(trinity.drought.freq, site_no, Year, freq)
westfork.flood.freq <- select(westfork.flood.freq, site_no, Year, freq)
westfork.drought.freq <- select(westfork.drought.freq, site_no, Year, freq)

# Make "Year" class numeric
trinity.flood.freq$Year <- as.numeric(trinity.flood.freq$Year)
trinity.drought.freq$Year <- as.numeric(trinity.drought.freq$Year)
westfork.flood.freq$Year <- as.numeric(westfork.flood.freq$Year)
westfork.drought.freq$Year <- as.numeric(westfork.drought.freq$Year)
```


```{r}
## Exploratory Graphs
explore1 <- ggplot(NULL, aes(x = discharge.mean)) +
  geom_histogram(data = trinity.flow, fill = "red") +
  geom_histogram(data = westfork.flow, fill = "blue", alpha = 0.5) +
  ylim(0,1500) +
  xlim(0,20000)
 
explore2 <- ggplot(all.flow.data) +
  geom_boxplot(aes(x = site_no, y = discharge.mean)) +
  ylim(0,2000)

print(explore1)
print(explore2)

explore3 <- ggplot(trinity.flood.freq, aes(x = Year, y = freq)) +
  geom_point() +
  geom_smooth(method = lm) +
  ylab("Frequency") +
  ggtitle("Trinity River Flood Occurance") +
  theme(plot.title = element_text(size = 12))

explore4 <- ggplot(trinity.drought.freq, aes(x = Year, y = freq)) +
  geom_point() +
  geom_smooth(method = lm, color = "red") +
  ylab("Frequency") +
  ggtitle("Trinity River Drought Occurance") +
  theme(plot.title = element_text(size = 12))

explore5 <- ggplot(westfork.flood.freq, aes(x = Year, y = freq)) +
  geom_point() +
  geom_smooth(method = lm) +
  scale_y_continuous(limits = c(0,250)) +
  ylab("Frequency") +
  ggtitle("West Fork Trinity River Flood Occurance") +
  theme(plot.title = element_text(size = 12))

explore6 <- ggplot(westfork.drought.freq, aes(x = Year, y = freq)) +
  geom_point() +
  geom_smooth(method = lm, color = "red") +
  scale_y_continuous(limits = c(0,300)) +
  ylab("Frequency") +
  ggtitle("West Fork Trinity River Drought Occurance") +
  theme(plot.title = element_text(size = 12)) 

grid.arrange(explore3, explore4, explore5, explore6)
```

<Include text sections to accompany these R chunks to explain the reasoning behind your workflow, and the rationale for your approach.>



\newpage

# Analysis
<Include R chunks for 3+ statistical tests (display code and output) and 3+ final visualization graphs (display graphs only).>
```{r}
# Run Man-Kendall test to test for monotonic relationship
mk.test(trinity.flood.freq$freq)
  # p < 0.05, trend present (z = +2.21)
mk.test(trinity.drought.freq$freq)
  # p < 0.05, trend present (z = -2.35)
mk.test(westfork.flood.freq$freq)
  # p < 0.05, trend present (z = +2.13)
mk.test(westfork.drought.freq$freq)
  # p < 0.05, trend present (z = -5.75)

# Run Pettitt's test 
pettitt.test(trinity.flood.freq$freq)
  # Change point @ row 56 (1980)
pettitt.test(trinity.drought.freq$freq)
  # Change point @ row 40 (1964)
pettitt.test(westfork.flood.freq$freq)
  # Change point @ row 64 (1988)
pettitt.test(westfork.drought.freq$freq)
  # Change point @ row 39 (1964)

# Run separate Man-Kendall for each change point
mk.test(trinity.flood.freq$freq[1:55])
  # p > 0.05, no trend
mk.test(trinity.flood.freq$freq[56:95])
  # p > 0.05, no trend
mk.test(trinity.drought.freq$freq[1:39])
  # p > 0.05, no trend
mk.test(trinity.drought.freq$freq[40:61])
  # p < 0.05, trend present (z = -2.09)
mk.test(westfork.flood.freq$freq[1:63])
  # p > 0.05, no trend
mk.test(westfork.flood.freq$freq[64:95])
  # p > 0.05, no trend
mk.test(westfork.drought.freq$freq[1:38])
  # p > 0.05, no trend
mk.test(westfork.drought.freq$freq[39:66])
  # P < 0.05, trend present (z = -3.42)

# Test for second change point
pettitt.test(trinity.drought.freq$freq[40:61])
  # p > 0.05, no change point
pettitt.test(westfork.drought.freq$freq[39:66])
  # p < 0.05, change point @ row 44 (1969)

# Run Spearman's Rho test (non-parametric)
cor.test(trinity.flood.freq$freq, trinity.flood.freq$Year, 
         method = "spearman", exact = FALSE)
cor.test(trinity.drought.freq$freq, trinity.drought.freq$Year, 
         method = "spearman", exact = FALSE)
cor.test(westfork.flood.freq$freq, westfork.flood.freq$Year, 
         method = "spearman", exact = FALSE)
cor.test(westfork.drought.freq$freq, westfork.drought.freq$Year, 
         method = "spearman", exact = FALSE)
```


```{r}
# Visualization Graphs

```

<Include text sections to accompany these R chunks to explain the reasoning behind your workflow, rationale for your approach, and the justification of meeting or failing to meet assumptions of tests.>


\newpage

# Summary and Conclusions
<Summarize your major findings from your analyses. What conclusions do you draw from your findings? Make sure to apply this to a broader application for the research question you have answered.>



